<div class="page-container">
  
  <div class="page-header animate-fade-in">
    <div class="header-content">
      <div class="icon-box">
        <mat-icon>folder_open</mat-icon>
      </div>
      <div>
        <h1>Gestión de Importaciones</h1>
        <p class="subtitle">Seguimiento logístico, DUA y costeo agrupado por carpetas</p>
      </div>
    </div>
    
    <button mat-stroked-button class="btn-secondary" routerLink="/compras/nueva">
      <mat-icon>add</mat-icon> Nueva Factura Comercial
    </button>
  </div>

  <div class="filters-bar card animate-fade-in">
    <div class="search-wrapper">
      <mat-icon>search</mat-icon>
      <input type="text" placeholder="Buscar por Importación, DUA, proveedor..." 
             [(ngModel)]="filtroTexto" (input)="filtrar()">
      <button class="btn-clear" *ngIf="filtroTexto" (click)="limpiarBusqueda()">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <div class="actions-group">
      <button mat-button class="btn-tool" [class.active-filter]="mostrarFiltros" (click)="toggleFiltros()">
        <mat-icon>{{ mostrarFiltros ? 'filter_list_off' : 'filter_list' }}</mat-icon>
        {{ mostrarFiltros ? 'Ocultar Filtros' : 'Filtros' }}
      </button>
    </div>
  </div>

  <div class="advanced-filters card animate-fade-in" *ngIf="mostrarFiltros">
     </div>

  <div class="table-card card animate-fade-in delay-1">
    
    <div class="loading-overlay" *ngIf="loading">
      <p>Cargando datos...</p>
    </div>

    <div class="table-responsive" *ngIf="!loading">
      <table class="soft-table">
        <thead>
          <tr>
            <th class="col-expander"></th>
            <th class="col-id">ID IMPORTACIÓN</th>
            <th class="col-estado">ESTADO GENERAL</th>
            <th class="col-proveedor">PROVEEDORES</th>
            <th class="col-eta">ETA (LLEGADA)</th>
            <th class="col-items text-center">ITEMS</th>
            <th class="col-money text-right">TOTAL FOB</th>
            <th class="col-money text-right">TOTAL COSTO</th>
          </tr>
        </thead>
        <tbody>
          
          <ng-container *ngFor="let group of gruposFiltrados">
            
            <tr class="master-row" [class.expanded-row]="group.expanded" (click)="toggleGroup(group)">
              <td class="col-expander">
                <mat-icon class="chevron-icon" [class.rotated]="group.expanded">expand_more</mat-icon>
              </td>
              <td class="col-id">
                <div class="folder-cell">
                  <mat-icon class="folder-icon">folder</mat-icon>
                  <span class="folder-name">{{ group.id }}</span>
                </div>
              </td>
              <td class="col-estado">
                <span class="status-badge" [ngClass]="getClassEstado(group.estadoGeneral)">
                  {{ getLabelEstado(group.estadoGeneral) }}
                </span>
              </td>
              <td class="col-proveedor">
                <div class="prov-list" [title]="group.proveedores">{{ group.proveedores || 'Varios' }}</div>
              </td>
              <td class="col-eta">
                <span *ngIf="group.fechaEta">{{ group.fechaEta | date:'dd MMM yyyy' }}</span>
                <span *ngIf="!group.fechaEta" class="placeholder-text">--</span>
              </td>
              <td class="col-items text-center">
                <span class="badge-count">{{ group.items.length }} doc</span>
              </td>
              <td class="col-money text-right">
                <span class="currency">{{ group.moneda === 'USD' ? '$' : 'S/' }}</span> 
                {{ group.totalFob | number:'1.2-2' }}
              </td>
              <td class="col-money total-highlight text-right">
                <span class="currency">{{ group.moneda === 'USD' ? '$' : 'S/' }}</span> 
                {{ group.totalCosto | number:'1.2-2' }}
              </td>
            </tr>

            <tr class="detail-row" *ngIf="group.expanded">
              <td colspan="8" class="detail-cell">
                <div class="detail-container">
                  
                  <table class="inner-table">
                    <colgroup>
                        <col class="i-col-tipo">
                        <col class="i-col-doc">
                        <col class="i-col-track">
                        <col class="i-col-log">
                        <col class="i-col-money">
                        <col class="i-col-money">
                        <col class="i-col-money">
                        <col class="i-col-action">
                    </colgroup>
                    <thead>
                      <tr>
                        <th class="text-center">TIPO</th>
                        <th>DOCUMENTO</th>
                        <th>TRACKING / DUA</th>
                        <th class="text-center">LOGÍSTICA</th>
                        <th class="text-right">FOB</th>
                        <th class="text-right">COSTOS IMP.</th>
                        <th class="text-right">TOTAL</th>
                        <th class="text-center">GESTIONAR</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr *ngFor="let item of group.items">
                        <td class="text-center">
                          <span class="type-tag">{{ item.compra.tipoComprobante }}</span>
                        </td>
                        <td>
                          <div class="cell-primary">{{ item.compra.nombreProveedor }}</div>
                          <div class="cell-secondary">{{ item.compra.serie }}-{{ item.compra.numero }}</div>
                        </td>
                        <td>
                          <div *ngIf="item.numeroDua" class="dua-tag">{{ item.numeroDua }}</div>
                          <div *ngIf="item.trackingNumber" class="track-tag">{{ item.trackingNumber }}</div>
                          <div *ngIf="!item.numeroDua && !item.trackingNumber" class="placeholder-text">--</div>
                        </td>
                        <td>
                          <div class="logistics-mini">
                            <mat-icon class="tiny-icon">{{ getIconoTransporte(item.tipoTransporte) }}</mat-icon>
                            <span>{{ item.paisOrigen || 'ND' }}</span>
                          </div>
                        </td>
                        <td class="text-right">
                          {{ item.compra.total | number:'1.2-2' }}
                        </td>
                        <td class="text-right text-muted">
                          + {{ calcularCostosExtra(item) | number:'1.2-2' }}
                        </td>
                        <td class="text-right font-weight-bold">
                          {{ (item.compra.total + calcularCostosExtra(item)) | number:'1.2-2' }}
                        </td>
                        <td class="text-center">
                          <button mat-icon-button class="btn-mini-edit" (click)="editarImportacion(item.id)">
                            <mat-icon>edit</mat-icon>
                          </button>
                        </td>
                      </tr>
                    </tbody>
                  </table>

                </div>
              </td>
            </tr>
          </ng-container>

        </tbody>
      </table>

      <div *ngIf="gruposFiltrados.length === 0" class="empty-state">
        <mat-icon>travel_explore</mat-icon>
        <p>No se encontraron importaciones.</p>
      </div>
    </div>
  </div>
</div>