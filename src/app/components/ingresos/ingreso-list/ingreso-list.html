<div class="ingresos-container">
  <div class="header">
    <div class="header-left">
      <div class="title-with-icon">
        <div class="icon-header">
          <mat-icon>archive</mat-icon>
        </div>
        <div>
          <h1>Ingreso de Productos</h1>
          <p class="subtitle">Gestiona las entradas de inventario y stock</p>
        </div>
      </div>
    </div>
    <div class="header-actions">
      <button mat-raised-button color="primary" class="btn-nuevo" (click)="abrirModalNuevoIngreso()">
        <mat-icon>add</mat-icon>
        Nuevo Ingreso
      </button>
    </div>
  </div>

  <div class="search-bar-section">
    <div class="filter-group search-main">
      <label class="search-label">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
        Buscar Registro:
      </label>
      <div class="input-wrapper">
        <input 
          type="text" 
          class="filter-input"
          placeholder="Buscar por producto, SKU o proveedor..." 
          [(ngModel)]="terminoBusqueda"
          (input)="buscarIngresos()"
        >
        <button class="btn-clear" *ngIf="terminoBusqueda" (click)="limpiarBusqueda()">
          <mat-icon>close</mat-icon>
        </button>
      </div>
    </div>

    <div class="secondary-actions">
      <button mat-stroked-button class="btn-secondary" (click)="abrirFiltros()">
        <mat-icon>filter_list</mat-icon>
        Filtros
      </button>
      <button mat-stroked-button class="btn-secondary" (click)="exportarDatos()">
        <mat-icon>file_download</mat-icon>
        Exportar
      </button>
    </div>
  </div>

  <div class="table-card">
    <div *ngIf="loading" class="state-container">
      <mat-spinner diameter="40"></mat-spinner>
      <p>Sincronizando ingresos...</p>
    </div>

    <div class="table-responsive" *ngIf="!loading && ingresosFiltrados.data.length > 0">
      <table mat-table [dataSource]="ingresosFiltrados" class="ingresos-table">
        
        <ng-container matColumnDef="id">
          <th mat-header-cell *matHeaderCellDef>ID</th>
          <td mat-cell *matCellDef="let ingreso">
            <span class="id-badge">#{{ingreso.id}}</span>
          </td>
        </ng-container>

        <ng-container matColumnDef="producto">
          <th mat-header-cell *matHeaderCellDef>PRODUCTO</th>
          <td mat-cell *matCellDef="let ingreso">
            <div class="producto-info">
              <div class="producto-avatar">
                <mat-icon>inventory_2</mat-icon>
              </div>
              <div class="text-group">
                <span class="main-text">{{ ingreso.nombreProducto }}</span>
                <span class="sub-text">SKU: {{ ingreso.skuProducto }}</span>
              </div>
            </div>
          </td>
        </ng-container>

        <ng-container matColumnDef="cantidad">
          <th mat-header-cell *matHeaderCellDef>CANTIDAD</th>
          <td mat-cell *matCellDef="let ingreso">
            <span class="cantidad-badge">
              <mat-icon>expand_less</mat-icon>
              {{ ingreso.cantidad }}
            </span>
          </td>
        </ng-container>

        <ng-container matColumnDef="proveedor">
          <th mat-header-cell *matHeaderCellDef>PROVEEDOR</th>
          <td mat-cell *matCellDef="let ingreso">
            <div class="icon-text-cell">
              <mat-icon>business</mat-icon>
              <span>{{ ingreso.proveedor || 'Sin asignar' }}</span>
            </div>
          </td>
        </ng-container>

        <ng-container matColumnDef="fecha">
          <th mat-header-cell *matHeaderCellDef>FECHA DE INGRESO</th>
          <td mat-cell *matCellDef="let ingreso">
            <div class="date-cell">
              <span class="main-text">{{ ingreso.fecha | date:'dd/MM/yyyy' }}</span>
              <span class="sub-text">{{ ingreso.fecha | date:'HH:mm' }}</span>
            </div>
          </td>
        </ng-container>

        <ng-container matColumnDef="observacion">
          <th mat-header-cell *matHeaderCellDef>NOTAS</th>
          <td mat-cell *matCellDef="let ingreso">
            <span class="nota-text" [matTooltip]="ingreso.observacion" *ngIf="ingreso.observacion">
              {{ (ingreso.observacion | slice:0:30) }}{{ ingreso.observacion.length > 30 ? '...' : '' }}
            </span>
            <span class="sin-datos" *ngIf="!ingreso.observacion">Sin notas</span>
          </td>
        </ng-container>

        <ng-container matColumnDef="acciones">
          <th mat-header-cell *matHeaderCellDef class="text-center">ACCIONES</th>
          <td mat-cell *matCellDef="let ingreso" class="text-center">
            <div class="action-buttons">
              <button mat-icon-button (click)="verDetalle(ingreso)" matTooltip="Ver detalle" class="action-btn btn-view">
                <mat-icon>visibility</mat-icon>
              </button>
              <button mat-icon-button (click)="editarIngreso(ingreso)" matTooltip="Editar" class="action-btn btn-edit">
                <mat-icon>edit</mat-icon>
              </button>
              <button mat-icon-button color="warn" (click)="eliminarIngreso(ingreso)" matTooltip="Eliminar" class="action-btn btn-delete">
                <mat-icon>delete_outline</mat-icon>
              </button>
            </div>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="row-hover"></tr>
      </table>
    </div>

    <div *ngIf="!loading && ingresosFiltrados.data.length === 0" class="state-container empty">
      <mat-icon>inbox</mat-icon>
      <p>No se encontraron registros de ingreso</p>
      <button mat-raised-button color="primary" (click)="abrirModalNuevoIngreso()">
        Registrar primer ingreso
      </button>
    </div>
  </div>
</div>

<app-ingreso-modal 
  *ngIf="mostrarModal" 
  (cerrarModal)="cerrarModal()"
  (registroExitoso)="onRegistroExitoso()">
</app-ingreso-modal>