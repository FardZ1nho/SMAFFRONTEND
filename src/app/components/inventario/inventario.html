<div class="inventario-container">
  
  <div class="page-header">
    <div class="header-content">
      <mat-icon class="header-icon">{{ vistaActual === 'PRODUCTO' ? 'inventory_2' : 'engineering' }}</mat-icon>
      <div>
        <h1>{{ vistaActual === 'PRODUCTO' ? 'Inventario de Productos' : 'Gesti칩n de Servicios' }}</h1>
        <p class="subtitle">{{ vistaActual === 'PRODUCTO' ? 'Gesti칩n de existencias f칤sicas' : 'Cat치logo de servicios ofrecidos' }}</p>
      </div>
    </div>
    
    <button mat-flat-button class="btn-nuevo" (click)="abrirModalNuevo()">
      <mat-icon>add</mat-icon> Nuevo {{ vistaActual | titlecase }}
    </button>
  </div>

  <div class="toolbar">
    <div class="search-wrapper">
      <mat-icon class="search-icon">search</mat-icon>
      <input type="text" class="filter-input" 
             placeholder="Buscar..." 
             [(ngModel)]="terminoBusqueda" (input)="aplicarFiltros()">
      
      <button class="btn-clear" *ngIf="terminoBusqueda" (click)="limpiarBusqueda()">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <div class="actions">
      <button mat-button class="btn-tool" 
              [class.active-filter-btn]="mostrarFiltros"
              (click)="toggleFiltros()">
        <mat-icon>{{ mostrarFiltros ? 'filter_list_off' : 'filter_list' }}</mat-icon> 
        {{ mostrarFiltros ? 'Ocultar' : 'Filtros' }}
      </button>
      
      <button mat-button class="btn-tool" (click)="exportarDatos()">
        <mat-icon>download</mat-icon> Exportar
      </button>
    </div>
  </div>

  <div class="advanced-filters-panel" *ngIf="mostrarFiltros">
    <div class="filters-grid">
      
      <mat-form-field appearance="outline" subscriptSizing="dynamic" class="filter-field">
        <mat-label>Categor칤a</mat-label>
        <mat-select [(ngModel)]="filtroCategoria" (selectionChange)="aplicarFiltros()">
          <mat-option value="TODAS">Todas</mat-option>
          <mat-option *ngFor="let cat of categoriasDisponibles" [value]="cat">{{ cat }}</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" subscriptSizing="dynamic" class="filter-field" *ngIf="vistaActual === 'PRODUCTO'">
        <mat-label>Estado Stock</mat-label>
        <mat-select [(ngModel)]="filtroEstadoStock" (selectionChange)="aplicarFiltros()">
          <mat-option value="TODOS">Todos</mat-option>
          <mat-option value="AGOTADO">游댮 Agotado (0)</mat-option>
          <mat-option value="BAJO">游 Bajo Stock</mat-option>
          <mat-option value="NORMAL">游댯 Normal</mat-option>
          <mat-option value="ALTO">游릭 Alto Stock</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" subscriptSizing="dynamic" class="filter-field">
        <mat-label>Precio Min ($)</mat-label>
        <input matInput type="number" [(ngModel)]="filtroPrecioMin" (input)="aplicarFiltros()" min="0">
      </mat-form-field>

      <mat-form-field appearance="outline" subscriptSizing="dynamic" class="filter-field">
        <mat-label>Precio Max ($)</mat-label>
        <input matInput type="number" [(ngModel)]="filtroPrecioMax" (input)="aplicarFiltros()" min="0">
      </mat-form-field>
    </div>

    <div class="filters-actions">
      <button mat-button color="warn" class="btn-reset" (click)="resetearFiltros()">
        <mat-icon>restart_alt</mat-icon> Limpiar Filtros
      </button>
    </div>
  </div>

  <div class="main-card">
    
    <div *ngIf="isLoading" class="state-container">
      <mat-spinner diameter="30"></mat-spinner>
      <p>Cargando datos...</p>
    </div>

    <div class="table-responsive" *ngIf="!isLoading">
      <table mat-table [dataSource]="productosFiltrados">

        <ng-container matColumnDef="codigo">
          <th mat-header-cell *matHeaderCellDef>C칍DIGO</th>
          <td mat-cell *matCellDef="let producto">
            <span class="sku-text">{{ producto.codigo || '---' }}</span>
          </td>
        </ng-container>

        <ng-container matColumnDef="nombre">
          <th mat-header-cell *matHeaderCellDef>DESCRIPCI칍N</th>
          <td mat-cell *matCellDef="let producto">
            <div class="product-cell">
              <div class="product-avatar-simple">
                <mat-icon>{{ vistaActual === 'SERVICIO' ? 'engineering' : 'inventory_2' }}</mat-icon>
              </div>
              <div class="product-info">
                <span class="name">{{ producto.nombre }}</span>
                <span class="desc" *ngIf="producto.descripcion">{{ producto.descripcion | slice:0:30 }}...</span>
              </div>
            </div>
          </td>
        </ng-container>

        <ng-container matColumnDef="categoria">
          <th mat-header-cell *matHeaderCellDef>CATEGOR칈A</th>
          <td mat-cell *matCellDef="let producto">
            <span class="category-badge">{{ producto.nombreCategoria || 'GENERAL' }}</span>
          </td>
        </ng-container>

       <ng-container matColumnDef="stock">
          <th mat-header-cell *matHeaderCellDef class="text-center">STOCK</th>
          <td mat-cell *matCellDef="let producto" class="text-center">
            <div class="stock-pill" [ngClass]="getStockClass(producto)">
              {{ producto.stockActual }}
            </div>
          </td>
        </ng-container>

        <ng-container matColumnDef="precio">
          <th mat-header-cell *matHeaderCellDef class="text-right">PRECIO</th>
          <td mat-cell *matCellDef="let producto" class="text-right">
            <span class="price-text">
              <span class="currency">{{ producto.moneda === 'PEN' ? 'S/' : '$' }}</span>
              {{ producto.precioVenta | number:'1.2-2' }}
            </span>
          </td>
        </ng-container>

        <ng-container matColumnDef="acciones">
          <th mat-header-cell *matHeaderCellDef class="text-right">ACCIONES</th>
          <td mat-cell *matCellDef="let producto" class="text-right">
            
            <button mat-icon-button class="btn-options" [matMenuTriggerFor]="menu">
              <mat-icon>more_vert</mat-icon>
            </button>

            <mat-menu #menu="matMenu" class="custom-menu" xPosition="before">
              <button mat-menu-item (click)="verDetalle(producto)">
                <mat-icon>visibility</mat-icon><span>Ver detalles</span>
              </button>
              
              <button mat-menu-item (click)="editarProducto(producto)">
                <mat-icon>edit</mat-icon><span>Editar</span>
              </button>

              <button mat-menu-item (click)="abrirModalStock(producto)" *ngIf="vistaActual === 'PRODUCTO'">
                <mat-icon style="color: #16a34a;">add_circle</mat-icon><span>Ingresar Stock</span>
              </button>
              
              <mat-divider></mat-divider>
              
              <button mat-menu-item class="menu-delete-item" (click)="eliminarProducto(producto)">
                <mat-icon>delete_outline</mat-icon><span>Eliminar</span>
              </button>
            </mat-menu>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="row-hover"></tr>
      </table>
    </div>

    <div *ngIf="!isLoading && productosFiltrados.data.length === 0" class="state-container">
      <mat-icon class="empty-icon">filter_alt_off</mat-icon>
      <p>No se encontraron {{ vistaActual === 'PRODUCTO' ? 'productos' : 'servicios' }} registrados.</p>
    </div>
  </div>
</div>