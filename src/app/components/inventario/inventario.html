<div class="inventario-container">
  
  <div class="page-header">
    <div class="header-content">
      <mat-icon class="header-icon">inventory_2</mat-icon>
      <div>
        <h1>Inventario</h1>
        <p class="subtitle">Gesti√≥n de existencias</p>
      </div>
    </div>
    
    <button mat-flat-button class="btn-nuevo" (click)="abrirModalNuevoProducto()">
      <mat-icon>add</mat-icon> Nuevo Producto
    </button>
  </div>

  <div class="toolbar">
    
    <div class="search-wrapper">
      <mat-icon class="search-icon">search</mat-icon>
      <input type="text" class="filter-input" 
             placeholder="Buscar por nombre, SKU o categor√≠a..." 
             [(ngModel)]="terminoBusqueda" (input)="aplicarFiltros()">
      
      <button class="btn-clear" *ngIf="terminoBusqueda" (click)="limpiarBusqueda()">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <div class="actions">
      <button mat-button class="btn-tool" 
              [class.active-filter-btn]="mostrarFiltros"
              (click)="toggleFiltros()">
        <mat-icon>{{ mostrarFiltros ? 'filter_list_off' : 'filter_list' }}</mat-icon> 
        {{ mostrarFiltros ? 'Ocultar' : 'Filtros' }}
      </button>
      
      <button mat-button class="btn-tool" (click)="exportarDatos()">
        <mat-icon>download</mat-icon> Exportar
      </button>
    </div>

  </div>

  <div class="advanced-filters-panel" *ngIf="mostrarFiltros">
    <div class="filters-grid">
      
      <mat-form-field appearance="outline" subscriptSizing="dynamic" class="filter-field">
        <mat-label>Categor√≠a</mat-label>
        <mat-select [(ngModel)]="filtroCategoria" (selectionChange)="aplicarFiltros()">
          <mat-option value="TODAS">Todas</mat-option>
          <mat-option *ngFor="let cat of categoriasDisponibles" [value]="cat">{{ cat }}</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" subscriptSizing="dynamic" class="filter-field">
        <mat-label>Tipo</mat-label>
        <mat-select [(ngModel)]="filtroTipo" (selectionChange)="aplicarFiltros()">
          <mat-option value="TODOS">Todos</mat-option>
          <mat-option value="PRODUCTO">Productos</mat-option>
          <mat-option value="SERVICIO">Servicios</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" subscriptSizing="dynamic" class="filter-field">
        <mat-label>Estado Stock</mat-label>
        <mat-select [(ngModel)]="filtroEstadoStock" (selectionChange)="aplicarFiltros()">
          <mat-option value="TODOS">Todos</mat-option>
          <mat-option value="AGOTADO">üî¥ Agotado (0)</mat-option>
          <mat-option value="BAJO">üü† Bajo Stock</mat-option>
          <mat-option value="NORMAL">üîµ Normal</mat-option>
          <mat-option value="ALTO">üü¢ Alto Stock</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" subscriptSizing="dynamic" class="filter-field">
        <mat-label>Precio Min ($)</mat-label>
        <input matInput type="number" [(ngModel)]="filtroPrecioMin" (input)="aplicarFiltros()" min="0">
      </mat-form-field>

      <mat-form-field appearance="outline" subscriptSizing="dynamic" class="filter-field">
        <mat-label>Precio Max ($)</mat-label>
        <input matInput type="number" [(ngModel)]="filtroPrecioMax" (input)="aplicarFiltros()" min="0">
      </mat-form-field>
    </div>

    <div class="filters-actions">
      <button mat-button color="warn" class="btn-reset" (click)="resetearFiltros()">
        <mat-icon>restart_alt</mat-icon> Limpiar Filtros
      </button>
    </div>
  </div>

  <div class="main-card">
    
    <div *ngIf="isLoading" class="state-container">
      <mat-spinner diameter="30"></mat-spinner>
      <p>Cargando...</p>
    </div>

    <div class="table-responsive" *ngIf="!isLoading">
      <table mat-table [dataSource]="productosFiltrados">

        <ng-container matColumnDef="codigo">
          <th mat-header-cell *matHeaderCellDef>SKU</th>
          <td mat-cell *matCellDef="let producto">
            <span class="sku-text">{{ producto.codigo }}</span>
          </td>
        </ng-container>

        <ng-container matColumnDef="nombre">
          <th mat-header-cell *matHeaderCellDef>PRODUCTO</th>
          <td mat-cell *matCellDef="let producto">
            <div class="product-cell">
              <div class="product-avatar-simple">
                <mat-icon>{{ producto.tipo === 'SERVICIO' ? 'engineering' : 'inventory' }}</mat-icon>
              </div>
              <div class="product-info">
                <span class="name">{{ producto.nombre }}</span>
                <span class="desc" *ngIf="producto.descripcion">{{ producto.descripcion | slice:0:30 }}...</span>
              </div>
            </div>
          </td>
        </ng-container>

        <ng-container matColumnDef="categoria">
          <th mat-header-cell *matHeaderCellDef>CATEGOR√çA</th>
          <td mat-cell *matCellDef="let producto">
            <span class="category-badge">{{ producto.nombreCategoria || 'GENERAL' }}</span>
          </td>
        </ng-container>

       <ng-container matColumnDef="stock">
          <th mat-header-cell *matHeaderCellDef class="text-center">STOCK</th>
          <td mat-cell *matCellDef="let producto" class="text-center">
            
            <div *ngIf="producto.tipo === 'PRODUCTO' || !producto.tipo" 
                 class="stock-pill" 
                 [ngClass]="getStockClass(producto)">
              {{ producto.stockActual }}
            </div>

            <div *ngIf="producto.tipo === 'SERVICIO'" class="service-badge">
              <mat-icon style="font-size: 14px; height: 14px; width: 14px; vertical-align: middle;">block</mat-icon>
              <span>N/A</span>
            </div>

          </td>
        </ng-container>

        <ng-container matColumnDef="precio">
          <th mat-header-cell *matHeaderCellDef class="text-right">PRECIO</th>
          <td mat-cell *matCellDef="let producto" class="text-right">
            <span class="price-text">
              <span class="currency">{{ producto.moneda === 'PEN' ? 'S/' : '$' }}</span>
              {{ producto.precioVenta | number:'1.2-2' }}
            </span>
          </td>
        </ng-container>

        <ng-container matColumnDef="acciones">
          <th mat-header-cell *matHeaderCellDef class="text-right">ACCIONES</th>
          <td mat-cell *matCellDef="let producto" class="text-right">
            
            <button mat-icon-button class="btn-options" [matMenuTriggerFor]="menu">
              <mat-icon>more_vert</mat-icon>
            </button>

            <mat-menu #menu="matMenu" class="custom-menu" xPosition="before">
              
              <button mat-menu-item (click)="verDetalle(producto)">
                <mat-icon>visibility</mat-icon>
                <span>Ver detalles</span>
              </button>
              
              <button mat-menu-item (click)="editarProducto(producto)">
                <mat-icon>edit</mat-icon>
                <span>Editar</span>
              </button>

              <button mat-menu-item (click)="abrirModalStock(producto)" *ngIf="producto.tipo !== 'SERVICIO'">
                <mat-icon style="color: #16a34a;">add_circle</mat-icon>
                <span>Ingresar Stock</span>
              </button>
              <mat-divider></mat-divider>
              
              <button mat-menu-item class="menu-delete-item" (click)="eliminarProducto(producto)">
                <mat-icon>delete_outline</mat-icon>
                <span>Eliminar</span>
              </button>

            </mat-menu>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="row-hover"></tr>
      </table>
    </div>

    <div *ngIf="!isLoading && productosFiltrados.data.length === 0" class="state-container">
      <mat-icon class="empty-icon">filter_alt_off</mat-icon>
      <p>No se encontraron resultados con los filtros actuales</p>
      <button mat-button color="primary" (click)="resetearFiltros()">Limpiar filtros</button>
    </div>
  </div>
</div>