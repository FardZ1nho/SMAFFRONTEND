<div class="modal-container">
  <div class="modal-header">
    <h2>{{ esEdicion ? 'Editar Producto' : 'Registrar Nuevo Producto' }}</h2>
    <button mat-icon-button type="button" (click)="cancelar()">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <div class="modal-content" *ngIf="!isLoading">
    <form [formGroup]="productoForm" class="producto-form" 
          (keydown.enter)="$any($event.target).tagName !== 'TEXTAREA' && $event.preventDefault()">
          
      <div class="form-row">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Nombre del Producto</mat-label>
          <input matInput formControlName="nombre" placeholder="Ej. Peine metálico">
          <mat-error *ngIf="nombre?.hasError('required')">Nombre requerido</mat-error>
          <mat-error *ngIf="nombre?.hasError('minlength')">Mínimo 3 caracteres</mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="half-width">
          <mat-label>Código SKU</mat-label>
          <input matInput formControlName="codigo" placeholder="Ej. H0043">
        </mat-form-field>
      </div>

      <div class="form-row">
        <mat-form-field appearance="outline" class="categoria-field">
          <mat-label>Categoría</mat-label>
          <mat-select formControlName="idCategoria">
            <mat-option *ngFor="let cat of categorias" [value]="cat.id">
              {{ cat.nombre }}
            </mat-option>
          </mat-select>
          <mat-error *ngIf="idCategoria?.hasError('required')">Seleccione categoría</mat-error>
        </mat-form-field>

        <div class="imagen-container">
          <div class="imagen-preview" (click)="fileInput.click()">
            <mat-icon *ngIf="!imagenPreview">add_photo_alternate</mat-icon>
            <img *ngIf="imagenPreview" [src]="imagenPreview" alt="Preview">
          </div>
          <input #fileInput type="file" accept="image/*" (change)="onImageSelect($event)" style="display: none">
        </div>
      </div>

      <div class="form-row">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Descripción</mat-label>
          <textarea matInput formControlName="descripcion" rows="3"></textarea>
        </mat-form-field>
      </div>

      <div class="section-divider">
        <h3><mat-icon>warehouse</mat-icon> Gestión de Stock</h3>
      </div>

      <div class="almacen-asignacion-container">
        <div class="form-row almacen-row">
          <mat-form-field appearance="outline" class="almacen-select">
            <mat-label>Almacén</mat-label>
            <mat-select [(ngModel)]="almacenSeleccionado" [ngModelOptions]="{standalone: true}">
              <mat-option *ngFor="let alm of almacenes" [value]="alm.id">
                {{ alm.nombre }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="stock-input">
            <mat-label>Stock</mat-label>
            <input matInput type="number" [(ngModel)]="stockAAgregar" [ngModelOptions]="{standalone: true}" min="0">
          </mat-form-field>

          <mat-form-field appearance="outline" class="ubicacion-input">
            <mat-label>Ubicación (Ej. A1)</mat-label>
            <input matInput [(ngModel)]="ubicacionFisicaAAgregar" [ngModelOptions]="{standalone: true}">
          </mat-form-field>

          <button mat-mini-fab color="primary" type="button" (click)="agregarStockAlmacen()" matTooltip="Agregar/Actualizar Stock">
            <mat-icon>add</mat-icon>
          </button>
        </div>

        <div class="almacenes-asignados" *ngIf="stockPorAlmacenes.length > 0">
          <div class="almacen-item" *ngFor="let item of stockPorAlmacenes; let i = index">
            <div class="almacen-info">
              <mat-icon>store</mat-icon>
              <div>
                <strong>{{ item.almacenNombre }}</strong>
                <span class="stock-detalle">Stock: {{ item.stock }} | Ubic: {{ item.ubicacionFisica || '-' }}</span>
              </div>
            </div>
            <button mat-icon-button color="warn" type="button" (click)="eliminarStockAlmacen(i)">
              <mat-icon>delete</mat-icon>
            </button>
          </div>
          <div class="stock-total-resumen">
            <strong>Total Global: {{ stockTotal }}</strong>
          </div>
        </div>
      </div>

      <div class="section-divider">
        <h3><mat-icon>attach_money</mat-icon> Precios y Costos</h3>
      </div>

      <div class="form-row">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Moneda</mat-label>
          <mat-select formControlName="moneda">
            <mat-option *ngFor="let m of monedas" [value]="m.codigo">{{ m.nombre }}</mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <div class="form-row">
        <mat-form-field appearance="outline" class="third-width">
          <mat-label>Precio China</mat-label>
          <input matInput type="number" formControlName="precioChina" step="0.01">
        </mat-form-field>
        <mat-form-field appearance="outline" class="third-width">
          <mat-label>Costo Total</mat-label>
          <input matInput type="number" formControlName="costoTotal" step="0.01">
        </mat-form-field>
        <mat-form-field appearance="outline" class="third-width">
          <mat-label>Precio Venta</mat-label>
          <input matInput type="number" formControlName="precioVenta" step="0.01">
        </mat-form-field>
      </div>

      <div class="form-row">
        <mat-form-field appearance="outline" class="half-width">
          <mat-label>Stock Mínimo (Alerta)</mat-label>
          <input matInput type="number" formControlName="stockMinimo">
        </mat-form-field>
      </div>

      <div class="modal-footer">
        <button mat-stroked-button type="button" (click)="cancelar()" [disabled]="isSaving">Cancelar</button>
        <button mat-raised-button color="primary" type="button" (click)="guardarProducto()" [disabled]="isSaving">
          <mat-spinner *ngIf="isSaving" diameter="20"></mat-spinner>
          <span *ngIf="!isSaving">{{ esEdicion ? 'Actualizar' : 'Guardar' }}</span>
        </button>
      </div>

    </form>
  </div>

  <div class="loading-container" *ngIf="isLoading">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Cargando datos...</p>
  </div>
</div>