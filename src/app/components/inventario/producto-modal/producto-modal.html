<div class="modal-container">
  
  <div class="modal-header">
    <div class="title-group">
      <h2>{{ esEdicion ? 'Editar' : 'Registrar' }} {{ tipoSeleccionado | titlecase }}</h2>
      <p class="subtitle">
        {{ tipoSeleccionado === 'PRODUCTO' ? 'Gestión de inventario físico y stock' : 'Gestión de servicios y mano de obra' }}
      </p>
    </div>
    <button mat-icon-button class="btn-close" type="button" (click)="cancelar()">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <div class="modal-content" *ngIf="!isLoading">
    <form [formGroup]="productoForm" class="producto-form">
      
      <div class="type-selector-container" *ngIf="!esEdicion && !tipoFijo">
        <div class="type-option" 
             [class.active]="tipoSeleccionado === 'PRODUCTO'" 
             (click)="cambiarTipo('PRODUCTO')">
          <mat-icon>inventory_2</mat-icon>
          <span>Producto</span>
          <div class="check-mark" *ngIf="tipoSeleccionado === 'PRODUCTO'"><mat-icon>check</mat-icon></div>
        </div>
        
        <div class="type-option" 
             [class.active]="tipoSeleccionado === 'SERVICIO'" 
             (click)="cambiarTipo('SERVICIO')">
          <mat-icon>engineering</mat-icon>
          <span>Servicio</span>
          <div class="check-mark" *ngIf="tipoSeleccionado === 'SERVICIO'"><mat-icon>check</mat-icon></div>
        </div>
      </div>

      <div *ngIf="tipoSeleccionado === 'SERVICIO'" class="animate-fade-in form-section">
        
        <div class="form-row">
          <div class="full-width">
            <mat-form-field appearance="outline" class="full-width" subscriptSizing="dynamic">
              <mat-label>Nombre del Servicio</mat-label>
              <input matInput formControlName="nombre" placeholder="Ej. Pulido de Pisos" autocomplete="off">
              <mat-spinner *ngIf="buscandoCoincidencias" matSuffix diameter="18"></mat-spinner>
              <mat-icon *ngIf="!buscandoCoincidencias" matSuffix class="text-gray">edit</mat-icon>
              <mat-error *ngIf="nombre?.hasError('required')">Requerido</mat-error>
            </mat-form-field>

            <div class="duplicados-alert animate-fade-in" *ngIf="coincidencias.length > 0">
              <div class="alert-header">
                <mat-icon>warning_amber</mat-icon>
                <span>Posibles coincidencias encontradas:</span>
              </div>
              <div class="duplicados-list">
                <div class="duplicado-item" *ngFor="let c of coincidencias" (click)="usarCoincidencia(c)">
                  <span class="dup-name">{{ c.nombre }}</span>
                  <span class="dup-code">{{ c.codigo || 'S/C' }}</span>
                </div>
              </div>
            </div>
          </div>
          
          <mat-form-field appearance="outline" class="half-width" subscriptSizing="dynamic">
            <mat-label>Código Interno</mat-label>
            <input matInput formControlName="codigo" placeholder="Ej. SERV-001">
            <mat-icon matSuffix class="text-gray">qr_code</mat-icon>
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline" class="half-width" subscriptSizing="dynamic">
            <mat-label>Moneda</mat-label>
            <mat-select formControlName="moneda">
              <mat-option *ngFor="let m of monedas" [value]="m.codigo">
                <span style="font-weight: bold;">{{ m.codigo }}</span> - {{ m.nombre }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="half-width" subscriptSizing="dynamic">
            <mat-label>Precio Unitario</mat-label>
            <span matPrefix class="prefix-symbol">$</span>
            <input matInput type="number" formControlName="precioVenta" class="price-input">
          </mat-form-field>
        </div>
        
        <div class="form-row">
           <mat-form-field appearance="outline" class="full-width" subscriptSizing="dynamic">
            <mat-label>Unidad de Medida</mat-label>
            <input matInput formControlName="unidadMedida" placeholder="Ej. Hora, Global, m2">
          </mat-form-field>
        </div>

        <div style="display: none;">
           <select formControlName="idCategoria"><option *ngFor="let c of categorias" [value]="c.id"></option></select>
        </div>
      </div>

      <div *ngIf="tipoSeleccionado === 'PRODUCTO'" class="animate-fade-in form-section">
          
        <div class="form-row">
          <div class="full-width">
            <mat-form-field appearance="outline" class="full-width" subscriptSizing="dynamic">
              <mat-label>Nombre del Producto</mat-label>
              <input matInput formControlName="nombre" placeholder="Ej. Martillo Hidráulico" autocomplete="off">
              <mat-spinner *ngIf="buscandoCoincidencias" matSuffix diameter="18"></mat-spinner>
              <mat-icon *ngIf="!buscandoCoincidencias" matSuffix class="text-gray">edit</mat-icon>
              <mat-error *ngIf="nombre?.hasError('required')">Requerido</mat-error>
            </mat-form-field>

            <div class="duplicados-alert animate-fade-in" *ngIf="coincidencias.length > 0">
              <div class="alert-header">
                <mat-icon>warning_amber</mat-icon>
                <span>Posibles coincidencias encontradas:</span>
              </div>
              <div class="duplicados-list">
                <div class="duplicado-item" *ngFor="let c of coincidencias" (click)="usarCoincidencia(c)">
                  <span class="dup-name">{{ c.nombre }}</span>
                  <span class="dup-code">{{ c.codigo || 'S/C' }}</span>
                </div>
              </div>
            </div>
          </div>

          <mat-form-field appearance="outline" class="half-width" subscriptSizing="dynamic">
            <mat-label>Código SKU</mat-label>
            <input matInput formControlName="codigo" placeholder="Ej. PROD-001">
            <mat-icon matSuffix class="text-gray">qr_code</mat-icon>
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline" class="full-width" subscriptSizing="dynamic">
            <mat-label>Categoría</mat-label>
            <mat-select formControlName="idCategoria">
              <mat-option *ngFor="let cat of categorias" [value]="cat.id">
                {{ cat.nombre }}
              </mat-option>
            </mat-select>
            <mat-error>Seleccione una categoría</mat-error>
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline" class="full-width" subscriptSizing="dynamic">
            <mat-label>Descripción (Opcional)</mat-label>
            <textarea matInput formControlName="descripcion" rows="2" placeholder="Detalles técnicos..."></textarea>
          </mat-form-field>
        </div>

        <div class="section-divider">
          <div class="icon-box"><mat-icon>payments</mat-icon></div>
          <h3>Precios y Costos</h3>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline" class="full-width" subscriptSizing="dynamic">
            <mat-label>Moneda Base</mat-label>
            <mat-select formControlName="moneda">
              <mat-option *ngFor="let m of monedas" [value]="m.codigo">
                <span style="font-weight: bold;">{{ m.codigo }}</span> - {{ m.nombre }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline" class="third-width" subscriptSizing="dynamic">
            <mat-label>Precio Compra</mat-label>
            <span matPrefix class="prefix-symbol">$</span>
            <input matInput type="number" formControlName="precioChina" placeholder="0.00">
          </mat-form-field>

          <mat-form-field appearance="outline" class="third-width" subscriptSizing="dynamic">
            <mat-label>Costo Unit.</mat-label>
            <span matPrefix class="prefix-symbol">$</span>
            <input matInput type="number" formControlName="costoTotal" placeholder="0.00">
          </mat-form-field>

          <mat-form-field appearance="outline" class="third-width" subscriptSizing="dynamic">
            <mat-label>Precio Venta</mat-label>
            <span matPrefix class="prefix-symbol">$</span>
            <input matInput type="number" formControlName="precioVenta" class="price-input" placeholder="0.00">
          </mat-form-field>
        </div>

        <div class="section-divider">
          <div class="icon-box"><mat-icon>settings</mat-icon></div>
          <h3>Configuración</h3>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline" class="half-width" subscriptSizing="dynamic">
            <mat-label>Unidad de Medida</mat-label>
            <input matInput formControlName="unidadMedida" placeholder="Ej. Unidad, Kit">
          </mat-form-field>

          <mat-form-field appearance="outline" class="half-width" subscriptSizing="dynamic">
            <mat-label>Alerta Stock Mínimo</mat-label>
            <input matInput type="number" formControlName="stockMinimo">
            <mat-icon matSuffix style="color: #f59e0b;">warning_amber</mat-icon>
          </mat-form-field>
        </div>
      </div>

    </form>
  </div>

  <div class="modal-footer" *ngIf="!isLoading">
    <button mat-button class="btn-cancel" type="button" (click)="cancelar()">Cancelar</button>
    <button mat-flat-button color="primary" class="btn-save" type="button" (click)="guardarProducto()" [disabled]="isSaving">
      <mat-icon *ngIf="!isSaving" style="margin-right: 8px;">save</mat-icon>
      <mat-spinner *ngIf="isSaving" diameter="20" class="spinner-white"></mat-spinner>
      {{ esEdicion ? 'Guardar Cambios' : 'Registrar ' + (tipoSeleccionado | titlecase) }}
    </button>
  </div>
</div>