<div class="modal-container">
  <div class="modal-header">
    <h2>Registrar Nuevo Producto</h2>
    <button mat-icon-button (click)="cancelar()">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <div class="modal-content" *ngIf="!isLoading">
    <form [formGroup]="productoForm" class="producto-form">

      <!-- Fila 1: Nombre y Código -->
      <div class="form-row">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Nombre del Producto</mat-label>
          <input matInput formControlName="nombre" placeholder="Ej. Peine metálico">
          <mat-error *ngIf="nombre?.hasError('required')">
            El nombre es requerido
          </mat-error>
          <mat-error *ngIf="nombre?.hasError('minlength')">
            Mínimo 3 caracteres
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="half-width">
          <mat-label>Código</mat-label>
          <input matInput formControlName="codigo" placeholder="Ej. H0043">
        </mat-form-field>
      </div>

      <!-- Fila 2: Categoría -->
      <div class="form-row">
        <mat-form-field appearance="outline" class="categoria-field">
          <mat-label>Categoría</mat-label>
          <mat-select formControlName="idCategoria" required>
            <mat-option *ngFor="let categoria of categorias" [value]="categoria.id">
              {{ categoria.nombre }}
            </mat-option>
          </mat-select>
          <mat-error *ngIf="idCategoria?.hasError('required')">
            Seleccione una categoría
          </mat-error>
        </mat-form-field>

        <button mat-raised-button type="button" class="btn-nueva-categoria" (click)="toggleNuevaCategoria()">
          Nueva Categoría
        </button>

        <!-- Sección de imagen -->
        <div class="imagen-container">
          <div class="imagen-preview" (click)="fileInput.click()">
            <mat-icon *ngIf="!imagenPreview">add_photo_alternate</mat-icon>
            <img *ngIf="imagenPreview" [src]="imagenPreview" alt="Preview">
            <mat-icon class="add-icon">add</mat-icon>
          </div>
          <input #fileInput type="file" accept="image/*" (change)="onImageSelect($event)" style="display: none">
        </div>
      </div>

      <!-- Descripción -->
      <div class="form-row">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Agrega una Descripción (Opcional)</mat-label>
          <textarea matInput formControlName="descripcion" rows="3"
            placeholder="Describe las características del producto..."></textarea>
        </mat-form-field>
      </div>

      <!-- ✅ NUEVA SECCIÓN: Asignación de Stock por Almacén -->
      <div class="section-divider">
        <h3>
          <mat-icon>warehouse</mat-icon>
          Asignación de Stock por Almacén
        </h3>
      </div>

      <!-- Formulario para agregar stock a almacenes -->
      <div class="almacen-asignacion-container">
        <div class="form-row almacen-row">
          <mat-form-field appearance="outline" class="almacen-select">
            <mat-label>Seleccionar Almacén</mat-label>
            <mat-select [(ngModel)]="almacenSeleccionado" [ngModelOptions]="{standalone: true}">
              <mat-option *ngFor="let almacen of almacenes" [value]="almacen.id">
                {{ almacen.codigo }} - {{ almacen.nombre }}
              </mat-option>
            </mat-select>
            <mat-icon matPrefix>store</mat-icon>
          </mat-form-field>

          <mat-form-field appearance="outline" class="stock-input">
            <mat-label>Cantidad</mat-label>
            <input matInput type="number" [(ngModel)]="stockAAgregar" [ngModelOptions]="{standalone: true}" 
                   placeholder="0" min="0">
            <mat-icon matPrefix>inventory_2</mat-icon>
          </mat-form-field>

          <mat-form-field appearance="outline" class="ubicacion-input">
            <mat-label>Ubicación Física (Opcional)</mat-label>
            <input matInput [(ngModel)]="ubicacionFisicaAAgregar" [ngModelOptions]="{standalone: true}" 
                   placeholder="Ej. A1-B3">
            <mat-icon matPrefix>location_on</mat-icon>
          </mat-form-field>

          <button mat-raised-button color="primary" type="button" (click)="agregarStockAlmacen()" 
                  class="btn-agregar-almacen">
            <mat-icon>add</mat-icon>
            Agregar
          </button>
        </div>

        <!-- Lista de almacenes asignados -->
        <div class="almacenes-asignados" *ngIf="stockPorAlmacenes.length > 0">
          <h4>Almacenes asignados:</h4>
          <div class="almacen-item" *ngFor="let item of stockPorAlmacenes; let i = index">
            <div class="almacen-info">
              <mat-icon>warehouse</mat-icon>
              <div class="almacen-detalles">
                <strong>{{ item.almacenCodigo }} - {{ item.almacenNombre }}</strong>
                <span class="stock-detalle">
                  Stock: <strong>{{ item.stock }}</strong> unidades
                  <span *ngIf="item.ubicacionFisica"> • Ubicación: {{ item.ubicacionFisica }}</span>
                </span>
              </div>
            </div>
            <button mat-icon-button color="warn" (click)="eliminarStockAlmacen(i)" type="button">
              <mat-icon>delete</mat-icon>
            </button>
          </div>

          <!-- Resumen de stock total -->
          <div class="stock-total-resumen">
            <mat-icon>summarize</mat-icon>
            <strong>Stock Total: {{ stockTotal }} unidades</strong>
            <span class="almacenes-count">(en {{ stockPorAlmacenes.length }} almacén(es))</span>
          </div>
        </div>

        <!-- Mensaje cuando no hay almacenes asignados -->
        <div class="sin-almacenes" *ngIf="stockPorAlmacenes.length === 0">
          <mat-icon>info</mat-icon>
          <p>Aún no has asignado este producto a ningún almacén. Agrega al menos uno para continuar.</p>
        </div>
      </div>

      <!-- Stock Mínimo General -->
      <div class="form-row">
        <mat-form-field appearance="outline" class="half-width">
          <mat-label>Stock Mínimo General (Alerta)</mat-label>
          <input matInput type="number" formControlName="stockMinimo" placeholder="5">
          <mat-icon matPrefix>warning</mat-icon>
          <mat-hint>Alerta cuando el stock total baje de este valor</mat-hint>
          <mat-error *ngIf="stockMinimo?.hasError('required')">Requerido</mat-error>
          <mat-error *ngIf="stockMinimo?.hasError('min')">Debe ser mayor o igual a 0</mat-error>
        </mat-form-field>
      </div>

      <!-- Control de Costo-Precio -->
      <div class="section-divider">
        <h3>Control de Costo-Precio</h3>
      </div>

      <!-- Selector de Moneda -->
      <div class="form-row">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Moneda</mat-label>
          <mat-select formControlName="moneda" required>
            <mat-option *ngFor="let moneda of monedas" [value]="moneda.codigo">
              {{ moneda.nombre }}
            </mat-option>
          </mat-select>
          <mat-icon matPrefix>attach_money</mat-icon>
          <mat-hint>Misma moneda para todos los precios</mat-hint>
          <mat-error *ngIf="moneda?.hasError('required')">
            Selecciona una moneda
          </mat-error>
        </mat-form-field>
      </div>

      <!-- Tres Precios -->
      <div class="form-row">
        <mat-form-field appearance="outline" class="third-width">
          <mat-label>Precio de China</mat-label>
          <input matInput type="number" step="0.01" formControlName="precioChina" placeholder="0.00" min="0">
          <mat-icon matPrefix>flag</mat-icon>
          <mat-hint>Precio en origen</mat-hint>
        </mat-form-field>

        <mat-form-field appearance="outline" class="third-width">
          <mat-label>Costo Total</mat-label>
          <input matInput type="number" step="0.01" formControlName="costoTotal" placeholder="0.00" min="0">
          <mat-icon matPrefix>local_shipping</mat-icon>
          <mat-hint>China + envío + impuestos</mat-hint>
        </mat-form-field>

        <mat-form-field appearance="outline" class="third-width">
          <mat-label>Precio de Venta</mat-label>
          <input matInput type="number" step="0.01" formControlName="precioVenta" placeholder="0.00" min="0">
          <mat-icon matPrefix>sell</mat-icon>
          <mat-hint>Precio al cliente</mat-hint>
        </mat-form-field>
      </div>

      <!-- Loading spinner -->
      <div class="loading-container" *ngIf="isLoading">
        <mat-spinner></mat-spinner>
      </div>

      <!-- Modal Footer -->
      <div class="modal-footer">
        <button mat-stroked-button (click)="cancelar()" [disabled]="isSaving">
          Cancelar
        </button>
        <button mat-raised-button color="primary" (click)="guardarProducto()" [disabled]="isSaving">
          <mat-spinner *ngIf="isSaving" diameter="20"></mat-spinner>
          <span *ngIf="!isSaving">Guardar Producto</span>
        </button>
      </div>
    </form>
  </div>
</div>