<div class="form-container">

    <div class="page-header">
        <div class="header-content">
            <div class="icon-box">
                <mat-icon>sync_alt</mat-icon>
            </div>
            <div>
                <h1>Registrar Traslado</h1>
                <p class="subtitle">Transfiere productos entre almacenes de forma segura</p>
            </div>
        </div>
    </div>

    <div *ngIf="cargando" class="state-container">
        <mat-spinner diameter="40"></mat-spinner>
        <p>Cargando información...</p>
    </div>

    <div *ngIf="!cargando" class="main-card-form">

        <div *ngIf="errorMensaje" class="error-banner">
            <mat-icon>error_outline</mat-icon>
            <span class="error-text">{{ errorMensaje }}</span>
            <button class="btn-close-error" (click)="limpiarError()">✕</button>
        </div>

        <div class="form-grid">
            <div class="selection-section">
                <form class="traslado-form">

                    <div class="form-group-custom">
                        <label class="input-label-header">
                            <mat-icon>inventory_2</mat-icon> PRODUCTO:
                        </label>
                        <div class="select-wrapper">
                            <select [(ngModel)]="productoId" name="producto" (ngModelChange)="onProductoChange()" required class="custom-input">
                                <option [ngValue]="null">-- Seleccionar Producto --</option>
                                <option *ngFor="let producto of productos" [ngValue]="producto.id">
                                    {{ producto.nombre }} ({{ producto.codigo }})
                                </option>
                            </select>
                        </div>
                    </div>

                    <div class="warehouses-grid">
                        <div class="form-group-custom">
                            <label class="input-label-header">ORIGEN:</label>
                            <div class="select-wrapper">
                                <select [(ngModel)]="almacenOrigenId" name="almacenOrigen" (ngModelChange)="onAlmacenOrigenChange()" required class="custom-input">
                                    <option [ngValue]="null">-- Seleccionar --</option>
                                    <option *ngFor="let almacen of almacenes" [ngValue]="almacen.id">
                                        {{ almacen.nombre }}
                                    </option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group-custom">
                            <label class="input-label-header">DESTINO:</label>
                            <div class="select-wrapper">
                                <select [(ngModel)]="almacenDestinoId" name="almacenDestino" required class="custom-input">
                                    <option [ngValue]="null">-- Seleccionar --</option>
                                    <option *ngFor="let almacen of almacenesDestino" [ngValue]="almacen.id">
                                        {{ almacen.nombre }}
                                    </option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-group-custom">
                        <label class="input-label-header">CANTIDAD A TRASLADAR:</label>
                        <input type="number" class="custom-input" placeholder="0" [(ngModel)]="cantidad" name="cantidad" min="1" required>
                    </div>

                    <div class="form-group-custom">
                        <label class="input-label-header">MOTIVO DEL MOVIMIENTO:</label>
                        <textarea class="custom-input textarea" placeholder="Escriba la razón del traslado..." [(ngModel)]="motivo" name="motivo" rows="3"></textarea>
                    </div>
                </form>
            </div>

            <div class="info-sidebar">
                <div class="summary-box" *ngIf="productoSeleccionado">
                    <h3>Detalles de Referencia</h3>
                    <div class="summary-item">
                        <span class="lbl">SKU</span>
                        <span class="val">{{ productoSeleccionado.codigo }}</span>
                    </div>
                    <div class="summary-item">
                        <span class="lbl">Stock Actual Total</span>
                        <span class="val highlight">{{ productoSeleccionado.stockActual }} und</span>
                    </div>
                </div>

                <div class="flow-visual" *ngIf="almacenOrigenId || almacenDestinoId">
                    <div class="flow-step" [class.active]="almacenOrigenId">
                        <mat-icon>warehouse</mat-icon>
                        <span>{{ almacenOrigenId ? obtenerNombreAlmacen(almacenOrigenId) : 'Origen' }}</span>
                    </div>
                    <div class="flow-arrow">
                        <mat-icon>arrow_downward</mat-icon>
                    </div>
                    <div class="flow-step destination" [class.active]="almacenDestinoId">
                        <mat-icon>location_on</mat-icon>
                        <span>{{ almacenDestinoId ? obtenerNombreAlmacen(almacenDestinoId) : 'Destino' }}</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="form-footer-actions">
            <button class="btn-cancel" (click)="cancelar()" [disabled]="guardando">
                Cancelar
            </button>
            <button class="btn-submit" (click)="registrarTraslado()" [disabled]="guardando">
                <mat-spinner *ngIf="guardando" diameter="20"></mat-spinner>
                <mat-icon *ngIf="!guardando">swap_horiz</mat-icon>
                <span>{{ guardando ? 'Registrando...' : 'Confirmar Traslado' }}</span>
            </button>
        </div>
    </div>
</div>