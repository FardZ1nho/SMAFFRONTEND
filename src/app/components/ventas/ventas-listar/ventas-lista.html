<div class="ventas-lista-container">
    
    <div class="header">
        <div class="header-left">
            <div class="title-with-icon">
                <div class="icon-header">
                    <mat-icon>receipt_long</mat-icon>
                </div>
                <div>
                    <h1>Lista de Ventas</h1>
                    <p class="subtitle">Gestiona y consulta todas las transacciones de tu negocio</p>
                </div>
            </div>
        </div>
        <div class="header-actions">
            <button mat-stroked-button color="warn" (click)="irANotasCredito()"
                style="margin-right: 12px; border-color: #fca5a5; color: #b91c1c;">
                <mat-icon>history</mat-icon>
                Ver Devoluciones
            </button>

            <button mat-raised-button color="primary" class="btn-nuevo" (click)="nuevaVenta()">
                <mat-icon>add</mat-icon>
                Nueva Venta
            </button>
        </div>
    </div>

    <mat-tab-group animationDuration="200ms" class="custom-tabs">
        
        <mat-tab label="Historial Completo">
            <div class="tab-content">
                
                <div class="search-bar-section">
                    <div class="filter-group search-main">
                        <label class="search-label">
                            <mat-icon style="font-size: 16px; width: 16px; height: 16px;">search</mat-icon>
                            Buscar Venta:
                        </label>
                        <div class="input-wrapper">
                            <input type="text" class="filter-input" placeholder="Buscar por código de ticket o nombre de cliente..."
                                [(ngModel)]="terminoBusqueda" (keyup)="buscarVentas()">
                            <button class="btn-clear" *ngIf="terminoBusqueda" (click)="limpiarBusqueda()">
                                <mat-icon>close</mat-icon>
                            </button>
                        </div>
                    </div>

                    <div class="secondary-filters">
                        <div class="filter-item">
                            <label class="search-label">Estado:</label>
                            <select class="filter-select" [(ngModel)]="estadoFiltro" (change)="onEstadoChange()">
                                <option *ngFor="let estado of estadosVenta" [value]="estado.value">
                                    {{ estado.label }}
                                </option>
                            </select>
                        </div>

                        <button mat-stroked-button class="btn-export" (click)="exportarDatos()">
                            <mat-icon>download</mat-icon>
                            Exportar
                        </button>
                    </div>
                </div>

                <div class="table-card">
                    <div *ngIf="isLoading" class="state-container">
                        <mat-spinner diameter="40"></mat-spinner>
                        <p>Sincronizando ventas...</p>
                    </div>

                    <div *ngIf="errorMessage && !isLoading" class="state-container error">
                        <mat-icon>error_outline</mat-icon>
                        <p>{{ errorMessage }}</p>
                        <button mat-flat-button color="warn" (click)="cargarVentas()">Reintentar</button>
                    </div>

                    <div *ngIf="!isLoading && !errorMessage && ventasFiltradas.data.length === 0" class="state-container empty">
                        <mat-icon>receipt</mat-icon>
                        <h3>No se encontraron ventas</h3>
                        <p>Ajusta los filtros o crea una nueva transacción</p>
                    </div>

                    <div class="table-responsive" *ngIf="!isLoading && !errorMessage && ventasFiltradas.data.length > 0">
                        <table mat-table [dataSource]="ventasFiltradas">

                            <ng-container matColumnDef="codigo">
                                <th mat-header-cell *matHeaderCellDef>Comprobante</th>
                                <td mat-cell *matCellDef="let venta">
                                    <div class="comprobante-cell">
                                        <span class="ticket-code">#{{ venta.codigo }}</span>
                                    </div>
                                </td>
                            </ng-container>

                            <ng-container matColumnDef="fechaVenta">
                                <th mat-header-cell *matHeaderCellDef>Fecha y Hora</th>
                                <td mat-cell *matCellDef="let venta">
                                    <div class="datetime-cell">
                                        <span class="date-val">{{ formatearFecha(venta.fechaVenta) }}</span>
                                    </div>
                                </td>
                            </ng-container>

                            <ng-container matColumnDef="cliente">
                                <th mat-header-cell *matHeaderCellDef>Cliente</th>
                                <td mat-cell *matCellDef="let venta">
                                    <div class="client-table-cell">
                                        <mat-icon>account_circle</mat-icon>
                                        <span>{{ venta.nombreCliente || 'Cliente General' }}</span>
                                    </div>
                                </td>
                            </ng-container>

                            <ng-container matColumnDef="metodoPago">
                                <th mat-header-cell *matHeaderCellDef>Pago</th>
                                <td mat-cell *matCellDef="let venta">
                                    <div class="payment-method-tag">
                                        <mat-icon>{{ getMetodoPagoIcon(venta.metodoPago) }}</mat-icon>
                                        <span>{{ venta.metodoPago }}</span>
                                        <span *ngIf="venta.tipoPago === 'CREDITO'" style="font-size: 10px; color: #dc2626; margin-left: 4px;">(CRÉDITO)</span>
                                    </div>
                                </td>
                            </ng-container>

                            <ng-container matColumnDef="total">
                                <th mat-header-cell *matHeaderCellDef>Monto</th>
                                <td mat-cell *matCellDef="let venta">
                                    <div style="display: flex; flex-direction: column; align-items: flex-end;">
                                        <span class="amount-val">S/ {{ venta.total.toFixed(2) }}</span>
                                        <span *ngIf="venta.estado === 'PENDIENTE'" style="font-size: 11px; color: #dc2626; font-weight: 600;">
                                            Debe: S/ {{ venta.saldoPendiente?.toFixed(2) }}
                                        </span>
                                    </div>
                                </td>
                            </ng-container>

                            <ng-container matColumnDef="estado">
                                <th mat-header-cell *matHeaderCellDef>Estado</th>
                                <td mat-cell *matCellDef="let venta">
                                    <span class="status-pill" [ngClass]="getEstadoClass(venta.estado)">
                                        {{ getEstadoLabel(venta.estado) }}
                                    </span>
                                </td>
                            </ng-container>

                            <ng-container matColumnDef="acciones">
                                <th mat-header-cell *matHeaderCellDef class="text-center">Acciones</th>
                                <td mat-cell *matCellDef="let venta" class="text-center">
                                    <button mat-icon-button [matMenuTriggerFor]="menu" class="btn-more">
                                        <mat-icon>more_horiz</mat-icon>
                                    </button>

                                    <mat-menu #menu="matMenu" class="modern-menu">
                                        <button mat-menu-item (click)="verDetalle(venta)">
                                            <mat-icon color="primary">visibility</mat-icon>
                                            <span>Ver Venta</span>
                                        </button>

                                        <button mat-menu-item (click)="amortizarDeuda(venta)" *ngIf="venta.estado === 'PENDIENTE'">
                                            <mat-icon style="color: #10b981;">attach_money</mat-icon>
                                            <span>Amortizar Deuda</span>
                                        </button>

                                        <button mat-menu-item (click)="abrirModalNotaCredito(venta)" *ngIf="venta.estado === 'COMPLETADA'">
                                            <mat-icon style="color: #ef4444;">replay</mat-icon>
                                            <span>Emitir Nota de Crédito</span>
                                        </button>

                                        <button mat-menu-item (click)="editarBorrador(venta)" *ngIf="venta.estado === 'BORRADOR'">
                                            <mat-icon style="color: #f59e0b;">edit</mat-icon>
                                            <span>Editar Borrador</span>
                                        </button>

                                        <button mat-menu-item (click)="completarVenta(venta)" *ngIf="venta.estado === 'BORRADOR'">
                                            <mat-icon style="color: #059669;">check_circle</mat-icon>
                                            <span>Emitir Venta</span>
                                        </button>

                                        <button mat-menu-item (click)="cancelarVenta(venta)" *ngIf="venta.estado !== 'CANCELADA'">
                                            <mat-icon color="warn">cancel</mat-icon>
                                            <span>Anular Comprobante</span>
                                        </button>

                                        <div mat-divider></div>

                                        <button mat-menu-item (click)="eliminarVenta(venta)" class="delete-item">
                                            <mat-icon>delete_forever</mat-icon>
                                            <span>Eliminar Registro</span>
                                        </button>
                                    </mat-menu>
                                </td>
                            </ng-container>

                            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                            <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="row-hover"></tr>
                        </table>
                    </div>
                </div>

                <div *ngIf="!isLoading && ventasFiltradas.data.length > 0" class="footer-stats">
                    <div class="stat-card">
                        <div class="stat-icon blue"><mat-icon>receipt_long</mat-icon></div>
                        <div class="stat-data">
                            <span class="stat-label">Total Documentos</span>
                            <span class="stat-value">{{ ventasFiltradas.data.length }}</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon green"><mat-icon>payments</mat-icon></div>
                        <div class="stat-data">
                            <span class="stat-label">Ingreso Neto</span>
                            <span class="stat-value">S/ {{ ingresoNetoReal.toFixed(2) }}</span>
                            <div style="font-size: 10px; color: #64748b; margin-top: 2px;">
                                Bruto: {{ totalVentas | number:'1.0-0' }} | Devoluciones: -{{ totalNotasCredito | number:'1.0-0' }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </mat-tab>

        <mat-tab label="Cuentas por Cobrar">
            <div class="tab-content">
                
                <div class="stats-row-deudas">
                    <div class="stat-card-debt total-debt">
                        <div class="stat-label">Total por Cobrar</div>
                        <div class="stat-value-debt text-danger">S/ {{ totalPorCobrar | number:'1.2-2' }}</div>
                    </div>
                    <div class="stat-card-debt">
                        <div class="stat-label">Clientes Deudores</div>
                        <div class="stat-value-debt">{{ clientesDeudores }}</div>
                    </div>
                </div>

                <div class="table-card">
                    <div *ngIf="deudasFiltradas.data.length === 0" class="state-container empty">
                        <mat-icon style="color: #10b981; font-size: 48px; width: 48px; height: 48px;">check_circle</mat-icon>
                        <h3>¡Todo al día!</h3>
                        <p>No tienes cuentas pendientes de cobro.</p>
                    </div>

                    <div class="table-responsive" *ngIf="deudasFiltradas.data.length > 0">
                        <table mat-table [dataSource]="deudasFiltradas">
                            
                            <ng-container matColumnDef="cliente">
                                <th mat-header-cell *matHeaderCellDef>Cliente</th>
                                <td mat-cell *matCellDef="let row">
                                    <div class="client-info">
                                        <span class="client-name">{{ row.nombreCliente }}</span>
                                        <span class="client-doc" *ngIf="row.numeroDocumentoCliente">{{ row.numeroDocumentoCliente }}</span>
                                    </div>
                                </td>
                            </ng-container>

                            <ng-container matColumnDef="codigo">
                                <th mat-header-cell *matHeaderCellDef>Factura</th>
                                <td mat-cell *matCellDef="let row"><span class="ticket-code">#{{ row.codigo }}</span></td>
                            </ng-container>

                            <ng-container matColumnDef="fechaVenta">
                                <th mat-header-cell *matHeaderCellDef>Emisión</th>
                                <td mat-cell *matCellDef="let row">{{ formatearFecha(row.fechaVenta) }}</td>
                            </ng-container>

                            <ng-container matColumnDef="total">
                                <th mat-header-cell *matHeaderCellDef class="text-right">Total Orig.</th>
                                <td mat-cell *matCellDef="let row" class="text-right">S/ {{ row.total | number:'1.2-2' }}</td>
                            </ng-container>

                            <ng-container matColumnDef="abonado">
                                <th mat-header-cell *matHeaderCellDef class="text-center">Progreso</th>
                                <td mat-cell *matCellDef="let row" class="text-center" style="width: 140px; padding: 0 16px;">
                                    <div class="progress-container">
                                        <span class="progress-text">{{ getPorcentajePagado(row) | number:'1.0-0' }}% Pagado</span>
                                        <mat-progress-bar mode="determinate" [value]="getPorcentajePagado(row)"></mat-progress-bar>
                                    </div>
                                </td>
                            </ng-container>

                            <ng-container matColumnDef="saldo">
                                <th mat-header-cell *matHeaderCellDef class="text-right">Deuda Actual</th>
                                <td mat-cell *matCellDef="let row" class="text-right">
                                    <span class="debt-amount">S/ {{ row.saldoPendiente | number:'1.2-2' }}</span>
                                </td>
                            </ng-container>

                            <ng-container matColumnDef="acciones">
                                <th mat-header-cell *matHeaderCellDef class="text-center">Acción</th>
                                <td mat-cell *matCellDef="let row" class="text-center">
                                    <button mat-flat-button color="primary" class="btn-cobrar" (click)="amortizarDeuda(row)">
                                        <mat-icon>payments</mat-icon> Cobrar
                                    </button>
                                </td>
                            </ng-container>

                            <tr mat-header-row *matHeaderRowDef="displayedColumnsDeudas"></tr>
                            <tr mat-row *matRowDef="let row; columns: displayedColumnsDeudas;" class="row-hover"></tr>
                        </table>
                    </div>
                </div>
            </div>
        </mat-tab>

    </mat-tab-group>
</div>