<div class="header">
    <h1>{{ esEdicion ? 'Editar Borrador' : 'Nueva Venta' }}</h1>
    <h3 *ngIf="esEdicion" style="color: #666;">Ticket #{{ventaId}}</h3>
</div>

  <div class="content-wrapper">
    <div class="left-column">
      
      <div class="search-section">
        <mat-form-field class="search-field" appearance="outline">
          <mat-icon matPrefix>search</mat-icon>
          <input 
            matInput 
            placeholder="Buscar por nombre o SKU..."
            [(ngModel)]="terminoBusqueda"
            (input)="buscarProductos()"
          >
        </mat-form-field>

        <div class="productos-list" *ngIf="terminoBusqueda && productosFiltrados.length > 0">
          <div 
            class="producto-item"
            *ngFor="let producto of productosFiltrados"
            (click)="agregarProducto(producto)"
          >
            <div class="producto-info">
              <span class="producto-nombre">{{ producto.nombre }}</span>
              <span class="producto-codigo">{{ producto.codigo }}</span>
            </div>
            <div class="producto-precio">
              <span>{{ producto.moneda === 'USD' ? '$' : 'S/' }} {{ producto.precioVenta?.toFixed(2) }}</span>
              <span class="stock-badge">Stock: {{ producto.stockActual }}</span>
            </div>
          </div>
        </div>
      </div>

      <div class="productos-venta-section">
        <h3>Productos en la Venta</h3>
        
        <div class="productos-venta-container" *ngIf="productosEnVenta.length > 0">
          <div class="producto-venta-item" *ngFor="let item of productosEnVenta; let i = index">
            <div class="producto-venta-header">
              <div class="producto-venta-info">
                <mat-icon class="producto-icon">inventory_2</mat-icon>
                <div>
                  <div class="producto-venta-nombre">{{ item.producto.nombre }}</div>
                  <div class="producto-venta-codigo">{{ item.producto?.codigo || '---' }}</div>
                </div>
              </div>
              <button 
                mat-icon-button 
                color="warn"
                (click)="eliminarProducto(i)"
                matTooltip="Eliminar producto"
              >
                <mat-icon>delete</mat-icon>
              </button>
            </div>

            <div class="producto-venta-details">
              <mat-form-field appearance="outline" class="small-field">
                <mat-label>Cant.</mat-label>
                <input 
                  matInput 
                  type="number"
                  [(ngModel)]="item.cantidad"
                  (ngModelChange)="onCantidadChange(item)"
                  min="1"
                >
              </mat-form-field>

              <mat-form-field appearance="outline" class="small-field">
                <mat-label>Precio Unit.</mat-label>
                <input 
                  matInput 
                  type="number"
                  [(ngModel)]="item.precioUnitario"
                  (ngModelChange)="onPrecioChange(item)"
                  step="0.01"
                >
              </mat-form-field>

              <mat-form-field appearance="outline" class="small-field">
                <mat-label>Desc. %</mat-label>
                <input 
                  matInput 
                  type="number"
                  [(ngModel)]="item.descuento"
                  (ngModelChange)="onDescuentoChange(item)"
                >
              </mat-form-field>

              <div class="subtotal-display">
                <span>Subtotal:</span>
                <strong>{{ moneda === 'PEN' ? 'S/' : '$' }} {{ item.subtotal.toFixed(2) }}</strong>
              </div>
            </div>
          </div>
        </div>

        <div class="empty-cart" *ngIf="productosEnVenta.length === 0">
          <mat-icon>shopping_cart</mat-icon>
          <p>No hay Productos Seleccionados</p>
          <p class="subtitle">Agregue productos para realizar la venta</p>
        </div>
      </div>
    </div>

    <div class="right-column">
      
      <div class="options-section card" style="padding: 15px; margin-bottom: 16px;">
        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
          <mat-form-field appearance="outline" style="flex: 2;">
            <mat-label>Comprobante</mat-label>
            <mat-select [(ngModel)]="tipoDocumento">
              <mat-option *ngFor="let doc of tiposDocumento" [value]="doc.value">
                {{ doc.label }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" style="flex: 1;">
            <mat-label>Moneda</mat-label>
            <mat-select [(ngModel)]="moneda" (selectionChange)="cambiarMoneda($event.value)">
              <mat-option value="PEN">Soles (S/)</mat-option>
              <mat-option value="USD">Dólares ($)</mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Tipo de Cambio</mat-label>
          <mat-icon matPrefix>currency_exchange</mat-icon>
          <input 
            matInput 
            type="number" 
            [(ngModel)]="tipoCambio" 
            (input)="onTipoCambioChange()" 
            step="0.01"
          >
          <mat-hint>Afecta la conversión de productos USD/PEN</mat-hint>
        </mat-form-field>
      </div>

      <div class="cliente-section card">
        <h3>Información del Cliente</h3>
        
        <div class="cliente-search-container">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Buscar Cliente *</mat-label>
            <input 
              matInput 
              [(ngModel)]="busquedaCliente" 
              (input)="buscarClientes()"
              placeholder="DNI, RUC o Nombre..."
            >
            <button 
              mat-icon-button 
              matSuffix 
              *ngIf="clienteSeleccionado" 
              (click)="limpiarCliente()"
            >
              <mat-icon>close</mat-icon>
            </button>
          </mat-form-field>

          <div class="clientes-dropdown" *ngIf="mostrarListaClientes && clientesFiltrados.length > 0">
            <div 
              class="cliente-item" 
              *ngFor="let c of clientesFiltrados" 
              (click)="seleccionarCliente(c)"
            >
              {{ c.nombreCompleto }} ({{ c.numeroDocumento }})
            </div>
          </div>

          <div class="cliente-seleccionado" *ngIf="clienteSeleccionado">
            <mat-icon color="primary">check_circle</mat-icon>
            <strong>{{ clienteSeleccionado.nombreCompleto }}</strong>
          </div>
        </div>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Método de Pago</mat-label>
          <mat-select [(ngModel)]="metodoPago">
            <mat-option *ngFor="let m of metodosPago" [value]="m.value">
              {{ m.label }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <div *ngIf="esPagoMixto()" class="pago-mixto-container">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Transferencia</mat-label>
            <input 
              matInput 
              type="number" 
              [(ngModel)]="pagoTransferencia" 
              (input)="validarMontoMixto('T')"
            >
            <span matSuffix>{{ moneda === 'PEN' ? 'S/' : '$' }}</span>
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Efectivo</mat-label>
            <input 
              matInput 
              type="number" 
              [(ngModel)]="pagoEfectivo" 
              (input)="validarMontoMixto('E')"
            >
            <span matSuffix>{{ moneda === 'PEN' ? 'S/' : '$' }}</span>
          </mat-form-field>
        </div>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Notas (Opcional)</mat-label>
          <textarea matInput [(ngModel)]="notas" rows="2"></textarea>
        </mat-form-field>
      </div>

      <div class="resumen-section card">
        <div class="resumen-row">
          <span>Subtotal:</span>
          <strong>{{ moneda === 'PEN' ? 'S/' : '$' }} {{ subtotal.toFixed(2) }}</strong>
        </div>
        <div class="resumen-row total">
          <span>Total:</span>
          <strong>{{ moneda === 'PEN' ? 'S/' : '$' }} {{ total.toFixed(2) }}</strong>
        </div>

        <div class="action-buttons">
          <button 
            mat-raised-button 
            color="primary" 
            (click)="completarVenta()" 
            [disabled]="productosEnVenta.length === 0 || !clienteSeleccionado || isSaving"
          >
            <mat-spinner *ngIf="isSaving" diameter="20"></mat-spinner>
            <span *ngIf="!isSaving">Completar Venta</span>
          </button>
          
          <button 
            mat-stroked-button 
            (click)="guardarComoBorrador()" 
            [disabled]="productosEnVenta.length === 0 || isSaving"
          >
            Guardar Borrador
          </button>
        </div>
      </div>

    </div>
  </div>
